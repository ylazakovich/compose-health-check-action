services:
  db:
    image: python:3.14-alpine
    command: >
      sh -c "
        echo 'DB starting...';
        sleep 6;
        echo 'DB serving...';
        python -m http.server 8081
      "
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8081', timeout=1)",
        ]
      interval: 1s
      timeout: 2s
      retries: 60
      start_period: 0s

  api:
    image: python:3.14-alpine
    depends_on:
      db:
        condition: service_healthy
    command: >
      sh -c "
        echo 'API starting (requires DB healthy)...';
        python -m http.server 8082
      "
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8082', timeout=1)",
        ]
      interval: 1s
      timeout: 2s
      retries: 60
      start_period: 0s

  web:
    image: nginx:1.29-alpine
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost"]
      interval: 1s
      timeout: 2s
      retries: 60
      start_period: 0s
